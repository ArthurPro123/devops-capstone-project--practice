# -------------------------------------------------
# Stage 1 – get Composer from the official image
# -------------------------------------------------
FROM composer:2 AS composer-stage   # contains /usr/bin/composer

# -------------------------------------------------
# Stage 2 – your PHP-Apache app
# -------------------------------------------------
FROM php:8.2-apache

# Install OS packages & PHP extensions needed by your app
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        default-mysql-client \
        ca-certificates \
        curl \
        libzip-dev && \
    docker-php-ext-install pdo pdo_mysql zip && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Copy Composer from the first stage
COPY --from=composer-stage /usr/bin/composer /usr/local/bin/composer

# (Optional) make sure it’s executable
RUN chmod +x /usr/local/bin/composer

# Enable Apache mod_rewrite
RUN a2enmod rewrite

# -------------------------------------------------
# Create a non-root user
# -------------------------------------------------
ARG UID=1000
ARG USER=theia
RUN useradd --uid ${UID} --create-home ${USER}

# -------------------------------------------------
# Set working directory (owned by the non-root user)
# -------------------------------------------------
WORKDIR /var/www/html

# -------------------------------------------------
# Copy source files with correct ownership
# -------------------------------------------------
COPY --chown=${USER}:${USER} src/ ./src/
COPY --chown=${USER}:${USER} config/ ./config/

# -------------------------------------------------
# Install PHP dependencies (run as root)
# -------------------------------------------------
RUN composer install --no-dev --optimize-autoloader

# -------------------------------------------------
# Switch to the non-root user for runtime
# -------------------------------------------------
USER ${USER}
EXPOSE 80
CMD ["apache2-foreground"]
